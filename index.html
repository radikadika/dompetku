<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DompetPintar</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* Gray 50 */
            -webkit-tap-highlight-color: transparent;
        }

        /* Custom Slider Styling */
        input[type=range].custom-range-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 24px; /* Area sentuh */
            background: transparent;
            outline: none;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            position: relative;
            z-index: 20;
        }

        /* Track Styles */
        input[type=range].custom-range-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, #10b981 0%, #eab308 50%, #ef4444 100%);
            border-radius: 4px;
            cursor: pointer;
        }
        input[type=range].custom-range-slider::-moz-range-track {
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, #10b981 0%, #eab308 50%, #ef4444 100%);
            border-radius: 4px;
            cursor: pointer;
        }

        /* Thumb Styles */
        input[type=range].custom-range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 4px; 
            background: #111827; 
            border: 1px solid white;
            border-radius: 1px;
            cursor: ew-resize;
            margin-top: -6px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        input[type=range].custom-range-slider::-moz-range-thumb {
            height: 20px;
            width: 4px;
            background: #111827;
            border: 1px solid white;
            border-radius: 1px;
            cursor: ew-resize;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* Animation Utilities */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#059669">
<link rel="apple-touch-icon" href="icon.png">

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => {
                    console.log('PWA ServiceWorker registered: ', registration.scope);
                }, err => {
                    console.log('PWA ServiceWorker registration failed: ', err);
                });
        });
    }
</script>
</head>
<body class="text-gray-800">

    <div class="max-w-md mx-auto bg-gray-50 min-h-screen relative shadow-2xl overflow-hidden flex flex-col">
        
        <!-- Top Bar -->
        <div class="bg-white p-4 flex justify-between items-center sticky top-0 z-30 shadow-sm no-print">
            <div class="flex items-center gap-2">
                <div class="bg-emerald-600 p-1.5 rounded-lg">
                    <i data-lucide="wallet" class="text-white w-5 h-5"></i>
                </div>
                <span class="font-bold text-lg text-gray-800">DompetPintar</span>
            </div>
            <div class="text-xs text-gray-500 font-medium bg-gray-100 px-2 py-1 rounded">
                v1.0.0
            </div>
        </div>

        <!-- Main Content Area -->
        <main id="app-content" class="flex-1 overflow-y-auto no-scrollbar p-4 pb-24 relative">
            <!-- Content will be injected here by JavaScript -->
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-2 z-40 max-w-md mx-auto no-print">
            <div class="flex justify-around items-center">
                <button onclick="router.navigate('home')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors text-gray-400 hover:text-gray-600" id="nav-home">
                    <i data-lucide="home" class="w-6 h-6"></i>
                    <span class="text-[10px] mt-1 font-medium">Beranda</span>
                </button>
                
                <button onclick="router.navigate('calendar')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors text-gray-400 hover:text-gray-600" id="nav-calendar">
                    <i data-lucide="calendar" class="w-6 h-6"></i>
                    <span class="text-[10px] mt-1 font-medium">Kalender</span>
                </button>

                <button onclick="router.navigate('add')" class="flex flex-col items-center justify-center -mt-8 bg-emerald-600 text-white w-14 h-14 rounded-full shadow-lg shadow-emerald-200 hover:bg-emerald-700 transition-colors">
                    <i data-lucide="plus-circle" class="w-7 h-7"></i>
                </button>

                <button onclick="router.navigate('analysis')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors text-gray-400 hover:text-gray-600" id="nav-analysis">
                    <i data-lucide="pie-chart" class="w-6 h-6"></i>
                    <span class="text-[10px] mt-1 font-medium">Monitor</span>
                </button>

                <button onclick="router.navigate('bills')" class="nav-btn flex flex-col items-center p-2 rounded-lg transition-colors text-gray-400 hover:text-gray-600" id="nav-bills">
                    <i data-lucide="receipt" class="w-6 h-6"></i>
                    <span class="text-[10px] mt-1 font-medium">Tagihan</span>
                </button>
            </div>
        </nav>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- STATE MANAGEMENT ---
        const state = {
            activeTab: 'home',
            transactions: [],
            bills: [],
            editingTransactionId: null,
            budgetSettings: {
                estimatedIncome: 5000000,
                startDay: 1, 
                allocations: [
                    { id: '1', name: 'Makanan & Minuman', percentage: 40, color: 'bg-orange-500' },
                    { id: '2', name: 'Transportasi', percentage: 10, color: 'bg-blue-500' },
                    { id: '3', name: 'Tagihan & Utilitas', percentage: 20, color: 'bg-red-500' },
                    { id: '4', name: 'Hiburan', percentage: 10, color: 'bg-purple-500' },
                    { id: '5', name: 'Tabungan/Investasi', percentage: 20, color: 'bg-emerald-500' },
                ]
            },
            calendarDate: new Date(),
            isEditingCategories: false, 
            isBudgetEditMode: false,
            newCategoryName: '',
            
            // Print/Report State
            isPrintModalOpen: false,
            printStartDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0], 
            printEndDate: new Date().toISOString().split('T')[0],

            tempTransaction: {
                amount: '',
                note: '',
                type: 'expense',
                category: '',
                date: ''
            },

            isAddingBill: false,
            editingBillId: null, 
            tempBill: {
                name: '',
                amount: '',
                date: '',
                type: 'monthly',
                category: '' 
            }
        };

        // --- UTILS ---
        const formatRupiah = (number) => {
            if (number === '' || number === null || number === undefined) return '';
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(number);
        };

        const generateId = () => Date.now().toString();

        const getColors = () => [
            'bg-orange-500', 'bg-blue-500', 'bg-red-500', 'bg-purple-500', 
            'bg-emerald-500', 'bg-pink-500', 'bg-indigo-500', 'bg-cyan-500', 
            'bg-yellow-500', 'bg-teal-500', 'bg-lime-500', 'bg-fuchsia-500'
        ];

        // --- PERIOD CALCULATOR HELPER ---
        const getPeriodRange = (startDay = 1) => {
            const today = new Date();
            let start = new Date(today.getFullYear(), today.getMonth(), startDay);
            let end = new Date(today.getFullYear(), today.getMonth() + 1, startDay - 1);

            if (today.getDate() < startDay) {
                start = new Date(today.getFullYear(), today.getMonth() - 1, startDay);
                end = new Date(today.getFullYear(), today.getMonth(), startDay - 1);
            }
            
            start.setHours(0,0,0,0);
            end.setHours(23,59,59,999);
            
            return { start, end };
        };

        // --- DATA PERSISTENCE ---
        const loadData = () => {
            const savedTx = localStorage.getItem('dompetPintar_transactions');
            const savedBudget = localStorage.getItem('dompetPintar_budget');
            const savedBills = localStorage.getItem('dompetPintar_bills');
            
            if (savedTx) state.transactions = JSON.parse(savedTx);
            if (savedBudget) {
                const parsed = JSON.parse(savedBudget);
                state.budgetSettings = { ...state.budgetSettings, ...parsed };
                if (!state.budgetSettings.startDay) state.budgetSettings.startDay = 1;
            }
            if (savedBills) {
                const parsedBills = JSON.parse(savedBills);
                state.bills = parsedBills.map(b => ({ ...b, type: b.type || 'monthly', category: b.category || '' }));
            }
        };

        const saveData = () => {
            localStorage.setItem('dompetPintar_transactions', JSON.stringify(state.transactions));
            localStorage.setItem('dompetPintar_budget', JSON.stringify(state.budgetSettings));
            localStorage.setItem('dompetPintar_bills', JSON.stringify(state.bills));
        };

        // --- ROUTER & RENDER ENGINE ---
        const router = {
            navigate: (tab) => {
                state.activeTab = tab;
                if (tab !== 'add' && state.editingTransactionId) {
                    state.editingTransactionId = null;
                    resetTempTransaction();
                }
                if (tab === 'add' && !state.editingTransactionId) {
                    resetTempTransaction();
                }
                if (tab !== 'bills') {
                    state.isAddingBill = false;
                    state.editingBillId = null;
                }
                if (tab === 'analysis') state.isBudgetEditMode = false;
                state.isPrintModalOpen = false;

                updateNavUI();
                renderContent();
            },
            editTransaction: (id) => {
                const tx = state.transactions.find(t => t.id === id);
                if (tx) {
                    state.editingTransactionId = id;
                    state.tempTransaction = {
                        amount: tx.amount,
                        note: tx.note,
                        type: tx.type,
                        category: tx.category,
                        date: new Date(tx.date).toISOString().split('T')[0]
                    };
                    router.navigate('add');
                }
            }
        };

        const updateNavUI = () => {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-emerald-600');
                btn.classList.add('text-gray-400');
                const icon = btn.querySelector('i');
                if(icon) icon.setAttribute('stroke-width', '2');
            });

            const activeBtn = document.getElementById(`nav-${state.activeTab}`);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-400');
                activeBtn.classList.add('text-emerald-600');
                const icon = activeBtn.querySelector('i');
                if(icon) icon.setAttribute('stroke-width', '2.5');
            }
            lucide.createIcons();
        };

        const renderContent = () => {
            const container = document.getElementById('app-content');
            container.innerHTML = ''; 

            switch (state.activeTab) {
                case 'home': container.innerHTML = Views.home(); break;
                case 'add': container.innerHTML = Views.add(); break;
                case 'analysis': container.innerHTML = Views.analysis(); break;
                case 'calendar': container.innerHTML = Views.calendar(); break;
                case 'bills': container.innerHTML = Views.bills(); break;
                case 'settings': container.innerHTML = Views.settings(); break;
            }
            lucide.createIcons();
            attachEventListeners();
        };

        const resetTempTransaction = () => {
            state.tempTransaction = {
                amount: '',
                note: '',
                type: 'expense',
                category: state.budgetSettings.allocations.length > 0 ? state.budgetSettings.allocations[0].name : '',
                date: new Date().toISOString().split('T')[0]
            };
        };

        // --- VIEWS ---
        const Views = {
            home: () => {
                const { start, end } = getPeriodRange(state.budgetSettings.startDay);
                
                const periodTx = state.transactions.filter(t => {
                    const d = new Date(t.date);
                    return d >= start && d <= end;
                });

                const income = periodTx.filter(t => t.type === 'income').reduce((acc, curr) => acc + curr.amount, 0);
                const expense = periodTx.filter(t => t.type === 'expense').reduce((acc, curr) => acc + curr.amount, 0);
                const balance = income - expense;

                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();

                const upcomingBills = state.bills
                    .map(b => {
                        let dueDate;
                        let periodKey; 
                        
                        if (b.type === 'monthly') {
                            const day = parseInt(b.date);
                            dueDate = new Date(currentYear, currentMonth, day);
                            if (day < today.getDate()) {
                                dueDate = new Date(currentYear, currentMonth + 1, day);
                            }
                            periodKey = `${dueDate.getFullYear()}-${dueDate.getMonth()}`;
                        } else {
                            dueDate = new Date(b.date);
                            periodKey = 'onetime';
                        }
                        
                        let isPaid = false;
                        if (b.type === 'onetime' && b.isPaid) isPaid = true;
                        if (b.type === 'monthly' && b.paidPeriods && b.paidPeriods.includes(periodKey)) isPaid = true;

                        return { ...b, dueDate, isPaid, periodKey };
                    })
                    .filter(b => {
                        if (b.isPaid) return false;
                        const diffTime = b.dueDate - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                        return diffDays >= -1 && diffDays <= 30; 
                    })
                    .sort((a, b) => a.dueDate - b.dueDate)
                    .slice(0, 5); 
                
                const periodStr = `${start.getDate()} ${start.toLocaleDateString('id-ID', {month:'short'})} - ${end.getDate()} ${end.toLocaleDateString('id-ID', {month:'short'})}`;

                return `
                    <div class="space-y-6 fade-in">
                        <div class="bg-emerald-600 text-white p-6 rounded-2xl shadow-lg shadow-emerald-200">
                            <div class="flex justify-between items-start mb-1">
                                <p class="text-emerald-100 text-sm font-medium">Saldo</p>
                                <span class="text-[10px] bg-emerald-700 px-2 py-0.5 rounded text-emerald-100 opacity-80">${periodStr}</span>
                            </div>
                            <h1 class="text-3xl font-bold mb-6">${formatRupiah(balance)}</h1>
                            <div class="flex gap-4">
                                <div class="flex-1 bg-white/20 p-3 rounded-xl backdrop-blur-sm">
                                    <div class="flex items-center gap-2 mb-1 text-emerald-100 text-xs">
                                        <i data-lucide="trending-down" class="w-3.5 h-3.5"></i> Pemasukan
                                    </div>
                                    <p class="font-semibold">${formatRupiah(income)}</p>
                                </div>
                                <div class="flex-1 bg-white/20 p-3 rounded-xl backdrop-blur-sm">
                                    <div class="flex items-center gap-2 mb-1 text-red-100 text-xs">
                                        <i data-lucide="trending-up" class="w-3.5 h-3.5"></i> Pengeluaran
                                    </div>
                                    <p class="font-semibold">${formatRupiah(expense)}</p>
                                </div>
                            </div>
                        </div>

                        ${upcomingBills.length > 0 ? `
                            <div>
                                <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                                    <i data-lucide="bell" class="w-4 h-4 text-blue-500"></i> Tagihan Segera
                                </h2>
                                <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                                    ${upcomingBills.map(bill => {
                                        const timeDiff = bill.dueDate.getTime() - new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
                                        const diff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                                        
                                        let alertColor = 'bg-blue-50 border-blue-100 text-blue-700';
                                        let timeText = `${diff} hari lagi`;
                                        let dateDisplay = bill.type === 'monthly' ? `Tgl ${parseInt(bill.date)}` : new Date(bill.date).toLocaleDateString('id-ID', {day: 'numeric', month: 'short'});

                                        if (diff === 0) {
                                            alertColor = 'bg-red-50 border-red-100 text-red-700';
                                            timeText = 'HARI INI!';
                                        } else if (diff < 0) {
                                            alertColor = 'bg-red-100 border-red-200 text-red-800';
                                            timeText = 'TERLEWAT!';
                                        } else if (diff <= 3) {
                                            alertColor = 'bg-orange-50 border-orange-100 text-orange-700';
                                        }

                                        return `
                                            <div class="min-w-[150px] p-3 rounded-xl border ${alertColor} shadow-sm flex-shrink-0 relative">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <p class="text-xs opacity-70 font-medium mb-1">${dateDisplay}</p>
                                                        <p class="font-bold text-sm truncate max-w-[90px]">${bill.name}</p>
                                                    </div>
                                                    <button onclick="Handlers.markBillPaid('${bill.id}', '${bill.periodKey}')" class="bg-white p-1.5 rounded-full shadow-sm text-green-600 hover:bg-green-50 border border-green-100" title="Tandai Sudah Dibayar">
                                                        <i data-lucide="check" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                                <p class="font-bold text-xs mt-2">${formatRupiah(bill.amount)}</p>
                                                <div class="mt-2 text-[10px] font-bold uppercase tracking-wider">${timeText}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-bold text-gray-800">Riwayat Transaksi</h2>
                                ${state.transactions.length > 0 ? `
                                    <button onclick="Handlers.resetAll()" class="text-xs text-red-500 flex items-center gap-1 hover:bg-red-50 px-2 py-1 rounded transition-colors">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i> Reset Semua
                                    </button>
                                ` : ''}
                            </div>
                            
                            <div class="space-y-3">
                                ${state.transactions.length === 0 ? `
                                    <div class="text-center py-10 bg-gray-50 rounded-xl border-dashed border-2 border-gray-200">
                                        <p class="text-gray-400">Belum ada transaksi</p>
                                        <button onclick="router.navigate('add')" class="mt-2 text-emerald-600 font-medium text-sm">
                                            + Tambah Transaksi
                                        </button>
                                    </div>
                                ` : state.transactions.map(t => `
                                    <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center group">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-full flex items-center justify-center ${t.type === 'income' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}">
                                                <i data-lucide="${t.type === 'income' ? 'wallet' : 'activity'}" class="w-5 h-5"></i>
                                            </div>
                                            <div>
                                                <p class="font-bold text-gray-800 text-sm">${t.note}</p>
                                                <p class="text-xs text-gray-500">${t.category} â€¢ ${new Date(t.date).toLocaleDateString('id-ID')}</p>
                                            </div>
                                        </div>
                                        <div class="flex flex-col items-end gap-1">
                                            <span class="font-bold text-sm ${t.type === 'income' ? 'text-emerald-600' : 'text-red-500'}">
                                                ${t.type === 'income' ? '+' : '-'} ${formatRupiah(t.amount)}
                                            </span>
                                            <button onclick="router.editTransaction('${t.id}')" class="text-gray-400 hover:text-emerald-600 text-[10px] flex items-center gap-1 bg-gray-50 px-2 py-1 rounded-full transition-colors">
                                                <i data-lucide="pencil" class="w-3 h-3"></i> Edit
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            add: () => {
                const isEditing = !!state.editingTransactionId;
                const { amount, note, type, category, date } = state.tempTransaction;
                let remainingPreview = 0;
                
                const txDate = date ? new Date(date) : new Date();
                
                if (type === 'expense' && category) {
                    const alloc = state.budgetSettings.allocations.find(a => a.name === category);
                    if (alloc) {
                        const budgetLimit = (state.budgetSettings.estimatedIncome * alloc.percentage) / 100;
                        const startDay = state.budgetSettings.startDay;
                        let pStart = new Date(txDate.getFullYear(), txDate.getMonth(), startDay);
                        if (txDate.getDate() < startDay) {
                            pStart = new Date(txDate.getFullYear(), txDate.getMonth() - 1, startDay);
                        }
                        let pEnd = new Date(pStart);
                        pEnd.setMonth(pEnd.getMonth() + 1);
                        pEnd.setDate(startDay - 1);
                        pEnd.setHours(23,59,59,999);
                        
                        const spent = state.transactions
                            .filter(t => {
                                const d = new Date(t.date);
                                return t.type === 'expense' && t.category === category && t.id !== state.editingTransactionId && d >= pStart && d <= pEnd;
                            })
                            .reduce((acc, curr) => acc + curr.amount, 0);
                            
                        const currentInput = parseFloat(amount) || 0;
                        remainingPreview = budgetLimit - spent - currentInput;
                    }
                }

                return `
                    <div class="space-y-4 fade-in">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">${isEditing ? 'Edit Transaksi' : 'Catat Transaksi'}</h2>
                            ${isEditing ? `<button onclick="router.navigate('home')" class="p-2 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200"><i data-lucide="x" class="w-5 h-5"></i></button>` : ''}
                        </div>
                        <div class="flex gap-2 mb-4">
                            <button onclick="Handlers.setFormType('expense')" class="flex-1 py-3 rounded-lg flex items-center justify-center gap-2 font-medium transition-colors ${type === 'expense' ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-600'}"><i data-lucide="minus-circle" class="w-5 h-5"></i> Pengeluaran</button>
                            <button onclick="Handlers.setFormType('income')" class="flex-1 py-3 rounded-lg flex items-center justify-center gap-2 font-medium transition-colors ${type === 'income' ? 'bg-emerald-500 text-white' : 'bg-gray-100 text-gray-600'}"><i data-lucide="plus-circle" class="w-5 h-5"></i> Pemasukan</button>
                        </div>
                        <form onsubmit="Handlers.submitTransaction(event)" class="space-y-4">
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label><input type="date" value="${date}" onchange="Handlers.updateForm('date', this.value)" class="w-full p-3 bg-white border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" required></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Jumlah</label><input type="text" inputmode="numeric" value="${amount ? formatRupiah(amount) : ''}" oninput="Handlers.handleAmountInput(this)" class="w-full p-3 text-lg font-semibold border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Rp 0" required></div>
                            ${type === 'expense' ? `<div><label class="block text-sm font-medium text-gray-700 mb-1">Kategori Budget</label><select onchange="Handlers.updateForm('category', this.value)" class="w-full p-3 bg-white border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">${state.budgetSettings.allocations.map(a => `<option value="${a.name}" ${category === a.name ? 'selected' : ''}>${a.name}</option>`).join('')}</select><div class="mt-2 px-1 flex justify-between items-center text-xs"><span class="text-gray-500">Sisa jatah:</span><span id="remaining-budget-text" class="font-bold ${remainingPreview < 0 ? 'text-red-500' : 'text-emerald-600'}">${formatRupiah(remainingPreview)}</span></div></div>` : ''}
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Catatan</label><input type="text" value="${note}" oninput="Handlers.updateForm('note', this.value)" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Contoh: Makan Siang" required></div>
                            <div class="flex gap-2 mt-6">${isEditing ? `<button type="button" onclick="Handlers.deleteTransaction('${state.editingTransactionId}')" class="w-1/4 py-4 bg-red-100 text-red-600 rounded-xl font-bold text-lg hover:bg-red-200 transition-colors flex items-center justify-center"><i data-lucide="trash-2" class="w-6 h-6"></i></button>` : ''}<button type="submit" class="flex-1 py-4 bg-gray-900 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-gray-800 transition-colors">${isEditing ? 'Update Transaksi' : 'Simpan Transaksi'}</button></div>
                        </form>
                    </div>`;
            },

            analysis: () => {
                if (state.isBudgetEditMode) {
                    return Views.settings(); 
                }

                // Period Calculation
                const { start, end } = getPeriodRange(state.budgetSettings.startDay);
                const periodStr = `${start.getDate()} ${start.toLocaleDateString('id-ID', {month:'short'})} - ${end.getDate()} ${end.toLocaleDateString('id-ID', {month:'short'})}`;

                // Filter transactions by period
                const periodTx = state.transactions.filter(t => {
                    const d = new Date(t.date);
                    return d >= start && d <= end;
                });

                const totalBudget = state.budgetSettings.estimatedIncome;
                const totalExpenses = periodTx
                    .filter(t => t.type === 'expense')
                    .reduce((acc, curr) => acc + curr.amount, 0);
                const totalRemaining = totalBudget - totalExpenses;

                // --- CHART DATA PREPARATION (Current Period) ---
                const expensesByCategory = {};
                periodTx
                    .filter(t => t.type === 'expense')
                    .forEach(t => {
                        expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
                    });

                let gradientString = '';
                let currentDeg = 0;
                const totalExpForChart = Math.max(totalExpenses, 1);
                
                const catColors = {};
                state.budgetSettings.allocations.forEach(a => {
                    const colorMap = {
                        'bg-orange-500': '#f97316', 'bg-blue-500': '#3b82f6', 'bg-red-500': '#ef4444',
                        'bg-purple-500': '#a855f7', 'bg-emerald-500': '#10b981', 'bg-pink-500': '#ec4899',
                        'bg-indigo-500': '#6366f1', 'bg-cyan-500': '#06b6d4', 'bg-yellow-500': '#eab308',
                        'bg-teal-500': '#14b8a6', 'bg-lime-500': '#84cc16', 'bg-fuchsia-500': '#d946ef'
                    };
                    catColors[a.name] = colorMap[a.color] || '#cbd5e1'; 
                });

                const chartSegments = Object.keys(expensesByCategory).map(cat => {
                    const amount = expensesByCategory[cat];
                    const deg = (amount / totalExpForChart) * 360;
                    const color = catColors[cat] || '#94a3b8';
                    const start = currentDeg;
                    currentDeg += deg;
                    return `${color} ${start}deg ${currentDeg}deg`;
                });

                if (chartSegments.length === 0) {
                    gradientString = '#f1f5f9 0deg 360deg'; 
                } else {
                    gradientString = chartSegments.join(', ');
                }

                // --- PREVIOUS PERIOD CALCULATION & CHART ---
                // Calculate previous period dates
                const prevStart = new Date(start);
                prevStart.setMonth(prevStart.getMonth() - 1);
                // prevEnd should be day before current start. current start is `start`.
                // end of previous period is `start` minus 1 millisecond.
                const prevEnd = new Date(start);
                prevEnd.setMilliseconds(-1);

                const prevPeriodStr = `${prevStart.getDate()} ${prevStart.toLocaleDateString('id-ID', {month:'short'})} - ${prevEnd.getDate()} ${prevEnd.toLocaleDateString('id-ID', {month:'short'})}`;

                // Filter previous period transactions
                const prevTx = state.transactions.filter(t => {
                    const d = new Date(t.date);
                    return d >= prevStart && d <= prevEnd && t.type === 'expense';
                });

                const prevTotalExpenses = prevTx.reduce((acc, curr) => acc + curr.amount, 0);

                // Prev Chart Data
                const prevExpensesByCategory = {};
                prevTx.forEach(t => {
                    prevExpensesByCategory[t.category] = (prevExpensesByCategory[t.category] || 0) + t.amount;
                });

                let prevGradientString = '';
                let prevCurrentDeg = 0;
                const prevTotalExpForChart = Math.max(prevTotalExpenses, 1);

                const prevChartSegments = Object.keys(prevExpensesByCategory).map(cat => {
                    const amount = prevExpensesByCategory[cat];
                    const deg = (amount / prevTotalExpForChart) * 360;
                    const color = catColors[cat] || '#94a3b8';
                    const start = prevCurrentDeg;
                    prevCurrentDeg += deg;
                    return `${color} ${start}deg ${prevCurrentDeg}deg`;
                });

                if (prevChartSegments.length === 0) {
                    prevGradientString = '#f1f5f9 0deg 360deg';
                } else {
                    prevGradientString = prevChartSegments.join(', ');
                }

                return `
                    <div class="space-y-6 fade-in">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Monitoring</h2>
                                <p class="text-[10px] text-gray-500">Periode: ${periodStr}</p>
                            </div>
                            <button onclick="Handlers.toggleBudgetEditMode()" class="text-xs flex items-center gap-1 bg-emerald-100 text-emerald-700 px-3 py-2 rounded-lg font-medium hover:bg-emerald-200 transition-colors">
                                <i data-lucide="settings-2" class="w-3.5 h-3.5"></i> Atur Budget
                            </button>
                        </div>
                        
                        <div class="bg-gradient-to-r from-gray-900 to-gray-800 text-white p-5 rounded-2xl shadow-lg border border-gray-700 relative overflow-hidden">
                            <div class="absolute top-0 right-0 -mt-2 -mr-2 w-24 h-24 bg-white opacity-5 rounded-full blur-2xl"></div>
                            <div class="relative z-10">
                                <p class="text-gray-400 text-xs font-medium uppercase tracking-wider mb-1">Total Sisa Dana Tersedia</p>
                                <p class="text-3xl font-bold mb-4 ${totalRemaining < 0 ? 'text-red-400' : 'text-emerald-400'}">${formatRupiah(totalRemaining)}</p>
                                <div class="grid grid-cols-2 gap-4 pt-4 border-t border-gray-700">
                                    <div><p class="text-gray-400 text-[10px]">Basis Anggaran</p><p class="font-semibold text-sm">${formatRupiah(totalBudget)}</p></div>
                                    <div class="text-right"><p class="text-gray-400 text-[10px]">Total Terpakai</p><p class="font-semibold text-sm text-red-400">${formatRupiah(totalExpenses)}</p></div>
                                </div>
                            </div>
                        </div>

                        ${totalExpenses > 0 ? `
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-800 mb-4 text-sm">Proporsi Pengeluaran (Bulan Ini)</h3>
                            <div class="flex items-center gap-6">
                                <div class="relative w-32 h-32 flex-shrink-0">
                                    <div class="w-full h-full rounded-full" style="background: conic-gradient(${gradientString})"></div>
                                    <div class="absolute inset-0 m-auto w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-inner">
                                        <span class="text-[10px] font-bold text-gray-400">Total<br>Keluar</span>
                                    </div>
                                </div>
                                <div class="flex-1 space-y-2 max-h-32 overflow-y-auto no-scrollbar">
                                    ${Object.keys(expensesByCategory).sort((a,b) => expensesByCategory[b] - expensesByCategory[a]).map(cat => `
                                        <div class="flex items-center justify-between text-xs">
                                            <div class="flex items-center gap-2">
                                                <div class="w-2.5 h-2.5 rounded-full" style="background-color: ${catColors[cat] || '#94a3b8'}"></div>
                                                <span class="text-gray-600 truncate max-w-[80px]">${cat}</span>
                                            </div>
                                            <span class="font-semibold">${Math.round((expensesByCategory[cat]/totalExpenses)*100)}%</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <div class="space-y-4">
                            ${state.budgetSettings.allocations.map(alloc => {
                                const budgetAmount = (state.budgetSettings.estimatedIncome * alloc.percentage) / 100;
                                const spentAmount = periodTx
                                    .filter(t => t.type === 'expense' && t.category === alloc.name)
                                    .reduce((acc, curr) => acc + curr.amount, 0);
                                const remainingAmount = budgetAmount - spentAmount;
                                const percentUsed = Math.min((spentAmount / budgetAmount) * 100, 100);
                                const isOverBudget = spentAmount > budgetAmount;

                                return `
                                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                        <div class="flex justify-between items-center mb-2">
                                            <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full ${alloc.color}"></div><span class="font-semibold text-gray-700">${alloc.name}</span></div>
                                            <span class="text-xs font-medium bg-gray-100 px-2 py-1 rounded text-gray-600">Jatah: ${alloc.percentage}%</span>
                                        </div>
                                        <div class="flex justify-between text-sm mb-1"><span class="text-gray-500">Terpakai: ${formatRupiah(spentAmount)}</span><span class="text-gray-500">Pagu: ${formatRupiah(budgetAmount)}</span></div>
                                        <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden"><div class="h-full rounded-full transition-all duration-500 ${isOverBudget ? 'bg-red-500' : alloc.color.replace('bg-', 'bg-opacity-80 bg-')}" style="width: ${percentUsed}%; background-color: ${isOverBudget ? '#ef4444' : ''}"></div></div>
                                        <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-50"><span class="text-xs text-gray-500 font-medium">Sisa Dana Tersedia</span><span class="text-sm font-bold ${remainingAmount < 0 ? 'text-red-500' : 'text-emerald-600'}">${formatRupiah(remainingAmount)}</span></div>
                                        ${isOverBudget ? `<p class="text-xs text-red-500 mt-1 font-medium flex items-center gap-1"><i data-lucide="activity" class="w-3 h-3"></i> Overbudget sebesar ${formatRupiah(Math.abs(remainingAmount))}</p>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <!-- Previous Period Recap (Only shown if there is data) -->
                        ${prevTotalExpenses > 0 ? `
                        <div class="mt-8 pt-6 border-t border-gray-200">
                            <h3 class="font-bold text-gray-800 mb-1">Rekapan Periode Lalu</h3>
                            <p class="text-xs text-gray-500 mb-4">${prevPeriodStr}</p>
                            
                            <div class="bg-gray-50 p-5 rounded-xl border border-gray-200 shadow-sm">
                                <div class="flex items-center gap-6">
                                    <div class="relative w-24 h-24 flex-shrink-0">
                                        <div class="w-full h-full rounded-full" style="background: conic-gradient(${prevGradientString})"></div>
                                        <div class="absolute inset-0 m-auto w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center"></div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="mb-2">
                                            <p class="text-[10px] uppercase text-gray-500 font-bold">Total Pengeluaran</p>
                                            <p class="text-lg font-bold text-gray-800">${formatRupiah(prevTotalExpenses)}</p>
                                        </div>
                                        <div class="space-y-1 max-h-24 overflow-y-auto no-scrollbar">
                                             ${Object.keys(prevExpensesByCategory).sort((a,b) => prevExpensesByCategory[b] - prevExpensesByCategory[a]).map(cat => `
                                                <div class="flex items-center justify-between text-[10px]">
                                                    <span class="text-gray-600 truncate max-w-[80px]">${cat}</span>
                                                    <span class="font-medium">${Math.round((prevExpensesByCategory[cat]/prevTotalExpenses)*100)}%</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}

                    </div>
                `;
            },

            // --- SETTINGS VIEW (Updated with Nominal Input) ---
            settings: () => {
                const totalPercentage = state.budgetSettings.allocations.reduce((acc, curr) => acc + curr.percentage, 0);
                const remainingPercentage = 100 - totalPercentage;
                const renderTicks = () => {
                    let ticks = '';
                    for(let i=0; i<=20; i++) {
                        const val = i * 5;
                        const isMajor = val % 10 === 0;
                        ticks += `<div class="absolute top-0 -translate-x-1/2 ${isMajor ? 'h-2 w-0.5 bg-gray-400' : 'h-1 w-px bg-gray-300'}" style="left: ${val}%">${isMajor ? `<span class="absolute top-2 -translate-x-1/2 text-[8px] text-gray-400 font-medium">${val}</span>` : ''}</div>`;
                    }
                    return ticks;
                };

                return `
                    <div class="space-y-6 fade-in">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <button onclick="Handlers.toggleBudgetEditMode()" class="p-1 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                                <h2 class="text-xl font-bold text-gray-800">Atur Anggaran</h2>
                            </div>
                            <button onclick="Handlers.toggleEditCategories()" class="text-xs px-3 py-2 rounded-lg font-medium transition-colors ${state.isEditingCategories ? 'bg-gray-200 text-gray-700' : 'bg-emerald-100 text-emerald-700'}">${state.isEditingCategories ? 'Selesai Edit' : 'Edit Kategori'}</button>
                        </div>

                        ${!state.isEditingCategories ? `
                        <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 space-y-3">
                            <div>
                                <label class="block text-xs font-bold text-emerald-800 mb-1">Tanggal Awal Periode</label>
                                <div class="flex items-center gap-2">
                                    <input type="range" min="1" max="28" value="${state.budgetSettings.startDay}" oninput="Handlers.updateStartDay(this.value)" class="w-full h-1 bg-emerald-200 rounded-lg appearance-none cursor-pointer">
                                    <span class="font-bold text-emerald-900 w-8 text-center" id="start-day-display">${state.budgetSettings.startDay}</span>
                                </div>
                                <p class="text-[10px] text-emerald-600 mt-1">Periode aktif dimulai dari tanggal ini setiap bulan.</p>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-emerald-800 mb-1">Estimasi Pemasukan</label>
                                <input type="text" inputmode="numeric" value="${formatRupiah(state.budgetSettings.estimatedIncome)}" oninput="Handlers.handleIncomeInput(this)" class="w-full p-2 bg-white border border-emerald-200 rounded text-emerald-900 font-bold text-sm">
                            </div>
                        </div>
                        ` : ''}

                        <div class="space-y-4">
                            <div class="flex justify-between items-start">
                                <h3 class="font-semibold text-gray-700 pt-1">${state.isEditingCategories ? 'Daftar Kategori' : 'Alokasi Persentase'}</h3>
                                ${!state.isEditingCategories ? `
                                    <div class="text-right">
                                        <div id="total-pct-badge" class="text-sm font-bold px-2 py-1 rounded inline-block ${totalPercentage === 100 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}">
                                            Total: ${totalPercentage}%
                                        </div>
                                        <div id="remaining-pct-text" class="text-xs text-orange-500 font-medium mt-1 px-1 animate-pulse" style="display: ${remainingPercentage > 0 ? 'block' : 'none'}">Sisa: ${remainingPercentage}%</div>
                                    </div>
                                ` : ''}
                            </div>
                            ${state.budgetSettings.allocations.map(alloc => {
                                const nominalVal = (state.budgetSettings.estimatedIncome * alloc.percentage) / 100;
                                return `
                                <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm transition-all">
                                    <div class="flex justify-between items-end mb-2 gap-2">
                                        <div class="flex items-center gap-2 mb-1 flex-1">
                                            <div class="w-3 h-3 rounded-full flex-shrink-0 ${alloc.color}"></div>
                                            ${state.isEditingCategories ? `<input type="text" value="${alloc.name}" oninput="Handlers.updateCategoryName('${alloc.id}', this.value)" class="flex-1 border-b border-gray-300 focus:border-emerald-500 outline-none text-gray-700 px-1">` : `<span class="font-medium text-gray-700">${alloc.name}</span>`}
                                        </div>
                                        ${state.isEditingCategories ? `<button onclick="Handlers.deleteCategory('${alloc.id}')" class="p-1.5 bg-red-50 text-red-500 rounded-lg hover:bg-red-100 z-10 mb-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : `
                                            <div class="text-right flex items-center gap-1 mb-1">
                                                <span class="font-bold text-gray-900 text-sm" id="pct-${alloc.id}">${alloc.percentage}%</span>
                                                <input 
                                                    type="text" 
                                                    inputmode="numeric"
                                                    id="amt-${alloc.id}"
                                                    value="${formatRupiah(nominalVal)}"
                                                    oninput="Handlers.updateNominalAllocation('${alloc.id}', this)"
                                                    class="text-xs text-gray-500 font-medium bg-transparent border-b border-gray-300 text-right w-24 focus:border-emerald-500 outline-none p-0.5"
                                                >
                                            </div>`}
                                    </div>
                                    ${!state.isEditingCategories ? `<div class="relative pt-2 pb-5 flex items-center"><input type="range" min="0" max="100" step="1" value="${alloc.percentage}" oninput="Handlers.updateSlider('${alloc.id}', this.value, this)" class="custom-range-slider relative z-20 block"><div class="absolute top-4 left-0 right-0 h-4 pointer-events-none z-10">${renderTicks()}</div></div>` : ''}
                                </div>
                            `}).join('')}
                            ${state.isEditingCategories ? `<div class="bg-gray-50 p-3 rounded-lg border border-dashed border-gray-300 flex gap-2 items-center mt-4"><input type="text" id="new-cat-input" placeholder="Nama kategori baru..." class="flex-1 bg-transparent outline-none text-sm p-2"><button onclick="Handlers.addCategory()" class="p-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700"><i data-lucide="plus-circle" class="w-5 h-5"></i></button></div>` : ''}
                        </div>
                        <button id="save-budget-btn" onclick="${state.isEditingCategories ? 'Handlers.toggleEditCategories()' : 'Handlers.saveSettings()'}" class="w-full py-3 rounded-xl font-bold text-white shadow-md transition-colors ${state.isEditingCategories ? 'bg-blue-600 hover:bg-blue-700' : (totalPercentage === 100 ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-gray-400 cursor-not-allowed')}" ${!state.isEditingCategories && totalPercentage !== 100 ? 'disabled' : ''}>${state.isEditingCategories ? 'Selesai Edit' : (totalPercentage === 100 ? 'Simpan & Kembali' : 'Total harus 100%')}</button>
                    </div>
                `;
            },

            bills: () => {
                const totalBills = state.bills.reduce((acc, curr) => acc + curr.amount, 0);
                const isEditing = !!state.editingBillId;
                
                return `
                    <div class="space-y-6 fade-in">
                        <div class="bg-blue-600 text-white p-6 rounded-2xl shadow-lg shadow-blue-200">
                            <div class="flex items-center gap-2 mb-1 text-blue-100 text-sm">
                                <i data-lucide="calendar-clock" class="w-4 h-4"></i> Estimasi Tagihan Bulanan
                            </div>
                            <h1 class="text-3xl font-bold">${formatRupiah(totalBills)}</h1>
                        </div>

                        ${!state.isAddingBill ? `
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-lg font-bold text-gray-800">Daftar Tagihan</h2>
                                    <button onclick="Handlers.toggleAddBill()" class="text-xs bg-blue-50 text-blue-600 px-3 py-2 rounded-lg font-medium hover:bg-blue-100 transition-colors flex items-center gap-1">
                                        <i data-lucide="plus" class="w-3 h-3"></i> Tambah
                                    </button>
                                </div>

                                <div class="space-y-3">
                                    ${state.bills.length === 0 ? `
                                        <div class="text-center py-10 bg-gray-50 rounded-xl border-dashed border-2 border-gray-200 text-gray-400 text-sm">Belum ada tagihan tersimpan</div>
                                    ` : state.bills.map(bill => {
                                        const today = new Date();
                                        let statusColor = 'bg-gray-100 text-gray-600';
                                        let statusText = '';
                                        if (bill.type === 'monthly') {
                                            const due = parseInt(bill.date);
                                            statusText = `Tiap tgl ${due}`;
                                            const diff = due - today.getDate();
                                            if (diff >= 0 && diff <= 3) statusColor = 'bg-red-100 text-red-600';
                                        } else {
                                            const due = new Date(bill.date);
                                            statusText = due.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: '2-digit' });
                                            const diff = Math.ceil((due - today) / (1000 * 3600 * 24));
                                            if (diff >= 0 && diff <= 3) statusColor = 'bg-red-100 text-red-600';
                                        }
                                        return `
                                            <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${bill.type === 'onetime' ? 'bg-orange-50 text-orange-600' : 'bg-blue-50 text-blue-600'}">
                                                        <i data-lucide="${bill.type === 'onetime' ? 'zap' : 'receipt'}" class="w-5 h-5"></i>
                                                    </div>
                                                    <div>
                                                        <p class="font-bold text-gray-800 text-sm">${bill.name}</p>
                                                        <div class="flex items-center gap-2">
                                                            <span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${statusColor}">${statusText}</span>
                                                            ${bill.category ? `<span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">${bill.category}</span>` : ''}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="flex flex-col items-end gap-1">
                                                    <span class="font-bold text-sm text-gray-800">${formatRupiah(bill.amount)}</span>
                                                    <div class="flex gap-2">
                                                        <button onclick="Handlers.editBill('${bill.id}')" class="text-gray-400 hover:text-blue-500 text-[10px] flex items-center gap-1 bg-gray-50 px-2 py-1 rounded-full transition-colors"><i data-lucide="pencil" class="w-3 h-3"></i> Edit</button>
                                                        <button onclick="Handlers.deleteBill('${bill.id}')" class="text-gray-400 hover:text-red-500 text-[10px] flex items-center gap-1 bg-gray-50 px-2 py-1 rounded-full transition-colors"><i data-lucide="trash-2" class="w-3 h-3"></i> Hapus</button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : `
                            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-gray-800">${isEditing ? 'Edit Tagihan' : 'Tambah Tagihan Baru'}</h3>
                                    <button onclick="Handlers.toggleAddBill()" class="p-1 rounded-full hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5 text-gray-500"></i></button>
                                </div>
                                <form onsubmit="Handlers.submitBill(event)" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipe Tagihan</label>
                                        <div class="flex gap-2">
                                            <button type="button" onclick="Handlers.setBillType('monthly')" class="flex-1 py-2 text-sm rounded-lg border ${state.tempBill.type === 'monthly' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-300'}">Rutin Bulanan</button>
                                            <button type="button" onclick="Handlers.setBillType('onetime')" class="flex-1 py-2 text-sm rounded-lg border ${state.tempBill.type === 'onetime' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-300'}">Sekali Saja</button>
                                        </div>
                                    </div>
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Nama Tagihan</label><input type="text" id="bill-name" value="${state.tempBill.name}" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Contoh: Listrik, Uang Gedung" required></div>
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Kategori Anggaran</label><select id="bill-category" class="w-full p-3 bg-white border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">${state.budgetSettings.allocations.map(a => `<option value="${a.name}" ${state.tempBill.category === a.name ? 'selected' : ''}>${a.name}</option>`).join('')}</select></div>
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Nominal</label><input type="text" inputmode="numeric" id="bill-amount" value="${formatRupiah(state.tempBill.amount)}" oninput="Handlers.handleBillAmount(this)" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Rp 0" required></div>
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">${state.tempBill.type === 'monthly' ? 'Tanggal Pembayaran (Tiap Bulan)' : 'Tanggal Jatuh Tempo'}</label>${state.tempBill.type === 'monthly' ? `<select id="bill-date" class="w-full p-3 bg-white border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">${Array.from({length: 31}, (_, i) => i + 1).map(d => `<option value="${d}" ${parseInt(state.tempBill.date) === d ? 'selected' : ''}>Tanggal ${d}</option>`).join('')}</select>` : `<input type="date" id="bill-date" value="${state.tempBill.date}" class="w-full p-3 bg-white border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>`}</div>
                                    <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-colors">${isEditing ? 'Simpan Perubahan' : 'Simpan Tagihan'}</button>
                                </form>
                            </div>
                        `}
                    </div>`;
            },
            
            calendar: () => {
                const year = state.calendarDate.getFullYear();
                const month = state.calendarDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay(); 
                const startDay = firstDay === 0 ? 6 : firstDay - 1; 
                const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                let daysHtml = '';
                for(let i=0; i<startDay; i++) daysHtml += `<div class="h-10"></div>`;
                for(let d=1; d<=daysInMonth; d++) {
                    const dateStr = new Date(year, month, d).toDateString();
                    const hasIncome = state.transactions.some(t => new Date(t.date).toDateString() === dateStr && t.type === 'income');
                    const hasExpense = state.transactions.some(t => new Date(t.date).toDateString() === dateStr && t.type === 'expense');
                    const hasBill = state.bills.some(b => {
                        if (b.type === 'monthly') return parseInt(b.date) === d;
                        if (b.type === 'onetime') {
                            const bDate = new Date(b.date);
                            return bDate.getDate() === d && bDate.getMonth() === month && bDate.getFullYear() === year;
                        }
                        return false;
                    });
                    const isSelected = state.calendarDate.getDate() === d;
                    daysHtml += `<button onclick="Handlers.setCalendarDate(${d})" class="h-10 w-full rounded-lg flex flex-col items-center justify-center relative transition-all ${isSelected ? 'bg-emerald-600 text-white shadow-md' : 'bg-white text-gray-700 hover:bg-gray-50 border border-gray-100'}"><span class="text-sm font-medium">${d}</span><div class="flex gap-0.5 mt-0.5">${hasIncome ? `<div class="w-1.5 h-1.5 rounded-full ${isSelected ? 'bg-emerald-200' : 'bg-emerald-500'}"></div>` : ''}${hasExpense ? `<div class="w-1.5 h-1.5 rounded-full ${isSelected ? 'bg-red-200' : 'bg-red-500'}"></div>` : ''}${hasBill ? `<div class="w-1.5 h-1.5 rounded-full ${isSelected ? 'bg-blue-200' : 'bg-blue-500'}"></div>` : ''}</div></button>`;
                }
                const selectedTx = state.transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getDate() === state.calendarDate.getDate() && tDate.getMonth() === month && tDate.getFullYear() === year;
                });
                
                const selectedBills = state.bills.filter(b => {
                    if (b.type === 'monthly') return parseInt(b.date) === state.calendarDate.getDate();
                    if (b.type === 'onetime') {
                        const bDate = new Date(b.date);
                        return bDate.getDate() === state.calendarDate.getDate() && bDate.getMonth() === month && bDate.getFullYear() === year;
                    }
                    return false;
                });
                const dailyIncome = selectedTx.filter(t => t.type === 'income').reduce((acc,curr) => acc + curr.amount, 0);
                const dailyExpense = selectedTx.filter(t => t.type === 'expense').reduce((acc,curr) => acc + curr.amount, 0);

                if (state.isPrintModalOpen) {
                    const printTx = state.transactions.filter(t => {
                        const tDate = new Date(t.date);
                        const sDate = new Date(state.printStartDate);
                        const eDate = new Date(state.printEndDate);
                        tDate.setHours(0,0,0,0);
                        sDate.setHours(0,0,0,0);
                        eDate.setHours(0,0,0,0);
                        return tDate >= sDate && tDate <= eDate;
                    }).sort((a,b) => new Date(b.date) - new Date(a.date));

                    const pInc = printTx.filter(t => t.type === 'income').reduce((acc,curr) => acc + curr.amount, 0);
                    const pExp = printTx.filter(t => t.type === 'expense').reduce((acc,curr) => acc + curr.amount, 0);

                    return `
                        <div class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
                            <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
                                <div class="p-4 border-b flex justify-between items-center bg-gray-50"><h3 class="font-bold text-lg text-gray-800">Cetak Laporan</h3><button onclick="Handlers.togglePrintMode()" class="p-2 hover:bg-gray-200 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                                <div class="p-4 grid grid-cols-2 gap-4 border-b"><div><label class="block text-xs font-medium text-gray-500 mb-1">Dari Tanggal</label><input type="date" value="${state.printStartDate}" onchange="Handlers.setPrintDate('start', this.value)" class="w-full p-2 border rounded-lg text-sm"></div><div><label class="block text-xs font-medium text-gray-500 mb-1">Sampai Tanggal</label><input type="date" value="${state.printEndDate}" onchange="Handlers.setPrintDate('end', this.value)" class="w-full p-2 border rounded-lg text-sm"></div></div>
                                <div class="flex-1 overflow-y-auto p-4" id="print-area">
                                    <div class="text-center mb-6"><h1 class="text-2xl font-bold text-emerald-700">Laporan Keuangan</h1><p class="text-sm text-gray-500">Periode: ${new Date(state.printStartDate).toLocaleDateString('id-ID')} - ${new Date(state.printEndDate).toLocaleDateString('id-ID')}</p></div>
                                    <div class="grid grid-cols-3 gap-2 mb-6 text-center"><div class="p-2 bg-emerald-50 rounded-lg border border-emerald-100"><p class="text-[10px] text-emerald-600 font-bold uppercase">Pemasukan</p><p class="text-sm font-bold text-emerald-700">${formatRupiah(pInc)}</p></div><div class="p-2 bg-red-50 rounded-lg border border-red-100"><p class="text-[10px] text-red-600 font-bold uppercase">Pengeluaran</p><p class="text-sm font-bold text-red-700">${formatRupiah(pExp)}</p></div><div class="p-2 bg-blue-50 rounded-lg border border-blue-100"><p class="text-[10px] text-blue-600 font-bold uppercase">Selisih</p><p class="text-sm font-bold text-blue-700">${formatRupiah(pInc - pExp)}</p></div></div>
                                    <table class="w-full text-sm text-left"><thead><tr class="border-b border-gray-300"><th class="py-2 font-bold text-gray-600">Tgl</th><th class="py-2 font-bold text-gray-600">Ket</th><th class="py-2 font-bold text-gray-600 text-right">Jml</th></tr></thead><tbody class="divide-y divide-gray-100">${printTx.length === 0 ? `<tr><td colspan="3" class="py-4 text-center text-gray-400 italic">Tidak ada data</td></tr>` : printTx.map(t => `<tr><td class="py-2 align-top text-gray-500 text-xs w-20">${new Date(t.date).toLocaleDateString('id-ID', {day:'numeric', month:'short'})}</td><td class="py-2 align-top"><div class="font-medium text-gray-800">${t.note}</div><div class="text-[10px] text-gray-500">${t.category}</div></td><td class="py-2 align-top text-right font-bold ${t.type==='income'?'text-emerald-600':'text-red-500'}">${t.type==='income'?'+':'-'} ${formatRupiah(t.amount)}</td></tr>`).join('')}</tbody></table>
                                </div>
                                <div class="p-4 border-t bg-white flex justify-end gap-2"><button onclick="Handlers.togglePrintMode()" class="px-4 py-2 text-sm font-bold text-gray-600 hover:bg-gray-100 rounded-lg">Tutup</button><button onclick="Handlers.printReport()" class="px-4 py-2 text-sm font-bold text-white bg-gray-900 hover:bg-gray-800 rounded-lg flex items-center gap-2"><i data-lucide="printer" class="w-4 h-4"></i> Cetak / PDF</button></div>
                            </div>
                        </div>`;
                }

                return `
                    <div class="space-y-6 fade-in">
                        <div class="flex justify-between items-center"><h2 class="text-xl font-bold text-gray-800">Kalender Transaksi</h2><button onclick="Handlers.togglePrintMode()" class="bg-white border border-gray-200 text-gray-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-gray-50 flex items-center gap-2"><i data-lucide="printer" class="w-3.5 h-3.5"></i> Laporan</button></div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4"><div class="flex justify-between items-center mb-4"><button onclick="Handlers.changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="chevron-left" class="w-5 h-5"></i></button><h3 class="font-bold text-lg text-gray-800">${monthNames[month]} ${year}</h3><button onclick="Handlers.changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="chevron-right" class="w-5 h-5"></i></button></div><div class="grid grid-cols-7 gap-2 mb-2 text-center text-xs font-semibold text-gray-400"><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div><div>Min</div></div><div class="grid grid-cols-7 gap-2">${daysHtml}</div></div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-end"><div><p class="text-gray-500 text-xs">Transaksi pada</p><h3 class="text-lg font-bold text-gray-800">${state.calendarDate.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</h3></div><div class="text-right">${dailyIncome > 0 ? `<p class="text-xs text-emerald-600 font-medium">+${formatRupiah(dailyIncome)}</p>` : ''}${dailyExpense > 0 ? `<p class="text-xs text-red-500 font-medium">-${formatRupiah(dailyExpense)}</p>` : ''}</div></div>
                            ${selectedBills.map(b => `<div class="bg-blue-50 p-4 rounded-xl border border-blue-100 shadow-sm flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center bg-blue-200 text-blue-700"><i data-lucide="receipt" class="w-5 h-5"></i></div><div><p class="font-bold text-blue-900 text-sm">${b.name}</p><p class="text-xs text-blue-600">Tagihan Jatuh Tempo</p></div></div><div class="font-bold text-sm text-blue-800">${formatRupiah(b.amount)}</div></div>`).join('')}
                            ${selectedTx.length === 0 && selectedBills.length === 0 ? `<div class="p-8 text-center bg-gray-50 rounded-xl border-dashed border border-gray-200 text-gray-400 text-sm">Tidak ada transaksi di tanggal ini</div>` : selectedTx.map(t => `<div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center ${t.type === 'income' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}"><i data-lucide="${t.type === 'income' ? 'wallet' : 'activity'}" class="w-5 h-5"></i></div><div><p class="font-bold text-gray-800 text-sm">${t.note}</p><p class="text-xs text-gray-500">${t.category}</p></div></div><div class="flex flex-col items-end gap-1"><span class="font-bold text-sm ${t.type === 'income' ? 'text-emerald-600' : 'text-red-500'}">${t.type === 'income' ? '+' : '-'} ${formatRupiah(t.amount)}</span><button onclick="router.editTransaction('${t.id}')" class="text-gray-400 hover:text-emerald-600 text-[10px] flex items-center gap-1 bg-gray-50 px-2 py-1 rounded-full transition-colors"><i data-lucide="pencil" class="w-3 h-3"></i> Edit</button></div></div>`).join('')}
                        </div>
                    </div>`;
            }
        };

        // --- HANDLERS (Event Logic) ---
        const Handlers = {
            resetAll: () => {
                if(confirm('Hapus semua data transaksi?')) {
                    state.transactions = [];
                    saveData();
                    renderContent();
                }
            },
            setFormType: (type) => {
                state.tempTransaction.type = type;
                renderContent();
            },
            
            handleAmountInput: (el) => {
                let rawValue = el.value.replace(/\D/g, '');
                state.tempTransaction.amount = rawValue ? parseFloat(rawValue) : '';
                el.value = rawValue ? formatRupiah(rawValue) : '';
                Handlers.updateBudgetPreview();
            },

            handleIncomeInput: (el) => {
                let rawValue = el.value.replace(/\D/g, '');
                state.budgetSettings.estimatedIncome = rawValue ? parseInt(rawValue) : 0;
                el.value = rawValue ? formatRupiah(rawValue) : '';
                Handlers.updateSliderAmounts();
            },
            
            // New Handler for Start Day
            updateStartDay: (val) => {
                state.budgetSettings.startDay = parseInt(val) || 1;
                document.getElementById('start-day-display').innerText = state.budgetSettings.startDay;
                saveData(); // Auto save
            },

            updateForm: (field, value) => {
                state.tempTransaction[field] = value;
                if(state.tempTransaction.type === 'expense' && field === 'category') {
                    Handlers.updateBudgetPreview();
                }
            },

            updateBudgetPreview: () => {
                const { category, amount, type } = state.tempTransaction;
                if(type !== 'expense') return;
                const displayEl = document.getElementById('remaining-budget-text');
                if(!displayEl) return;
                const alloc = state.budgetSettings.allocations.find(a => a.name === category);
                if (alloc) {
                    const budgetLimit = (state.budgetSettings.estimatedIncome * alloc.percentage) / 100;
                    
                    // CALCULATE SPENT IN CURRENT PERIOD (MATCHING ADDED LOGIC)
                    const { start, end } = getPeriodRange(state.budgetSettings.startDay);
                    const spent = state.transactions
                        .filter(t => {
                            const d = new Date(t.date);
                            return t.type === 'expense' && t.category === category && t.id !== state.editingTransactionId && d >= start && d <= end;
                        })
                        .reduce((acc, curr) => acc + curr.amount, 0);
                        
                    const currentInput = typeof amount === 'number' ? amount : 0;
                    const remaining = budgetLimit - spent - currentInput;
                    displayEl.innerText = formatRupiah(remaining);
                    displayEl.className = `font-bold ${remaining < 0 ? 'text-red-500' : 'text-emerald-600'}`;
                }
            },

            updateSliderAmounts: () => {
                state.budgetSettings.allocations.forEach(alloc => {
                    const el = document.getElementById(`amt-${alloc.id}`);
                    if(el) {
                        if (el.tagName === 'INPUT') {
                             el.value = formatRupiah((state.budgetSettings.estimatedIncome * alloc.percentage) / 100);
                        } else {
                             el.innerText = `(${formatRupiah((state.budgetSettings.estimatedIncome * alloc.percentage) / 100)})`;
                        }
                    }
                });
            },

            updateNominalAllocation: (id, el) => {
                let rawValue = el.value.replace(/\D/g, '');
                let nominal = rawValue ? parseInt(rawValue) : 0;
                
                el.value = rawValue ? formatRupiah(rawValue) : '';

                let percentage = 0;
                if (state.budgetSettings.estimatedIncome > 0) {
                    percentage = Math.round((nominal / state.budgetSettings.estimatedIncome) * 100);
                }

                Handlers.updateSlider(id, percentage, null, true); 
            },

            updateSlider: (id, val, el, fromNominal = false) => {
                const numVal = parseInt(val) || 0;
                const otherTotal = state.budgetSettings.allocations.filter(a => a.id !== id).reduce((acc, curr) => acc + curr.percentage, 0);
                
                let acceptedVal = numVal;
                if (otherTotal + numVal > 100) acceptedVal = 100 - otherTotal;
                
                if (!fromNominal && el && acceptedVal !== numVal) {
                    el.value = acceptedVal;
                }

                const alloc = state.budgetSettings.allocations.find(a => a.id === id);
                if (alloc) alloc.percentage = acceptedVal;

                const pctEl = document.getElementById(`pct-${id}`);
                const amtEl = document.getElementById(`amt-${id}`);
                const sliderEl = el || document.querySelector(`input[type="range"][oninput*="'${id}'"]`);

                if(pctEl) pctEl.innerText = acceptedVal + '%';
                
                if (!fromNominal && amtEl) {
                    amtEl.value = formatRupiah((state.budgetSettings.estimatedIncome * acceptedVal) / 100);
                }

                if (fromNominal && sliderEl) {
                    sliderEl.value = acceptedVal;
                }

                // NEW LOGIC TO UPDATE TOTALS
                const totalPct = state.budgetSettings.allocations.reduce((acc, curr) => acc + curr.percentage, 0);
                const remaining = 100 - totalPct;
                
                const totalEl = document.getElementById('total-pct-badge');
                const remainingEl = document.getElementById('remaining-pct-text');
                
                if (totalEl) {
                    totalEl.innerText = `Total: ${totalPct}%`;
                    if (totalPct === 100) {
                        totalEl.className = 'text-sm font-bold px-2 py-1 rounded inline-block bg-green-100 text-green-700';
                    } else {
                        totalEl.className = 'text-sm font-bold px-2 py-1 rounded inline-block bg-gray-100 text-gray-600';
                    }
                }
                
                if (remainingEl) {
                    remainingEl.innerText = `Sisa: ${remaining}%`;
                    remainingEl.style.display = remaining > 0 ? 'block' : 'none';
                }

                // Update Save Button State using specific ID
                const actionBtn = document.getElementById('save-budget-btn');
                if (actionBtn && !state.isEditingCategories) {
                     if (totalPct === 100) {
                        actionBtn.disabled = false;
                        actionBtn.innerText = 'Simpan & Kembali';
                        actionBtn.className = "w-full py-3 rounded-xl font-bold text-white shadow-md transition-colors bg-emerald-600 hover:bg-emerald-700";
                    } else {
                        actionBtn.disabled = true;
                        actionBtn.innerText = 'Total harus 100%';
                        actionBtn.className = "w-full py-3 rounded-xl font-bold text-white shadow-md transition-colors bg-gray-400 cursor-not-allowed";
                    }
                }
            },

            submitTransaction: (e) => {
                e.preventDefault();
                const { amount, note, type, category, date } = state.tempTransaction;
                if (!amount || !note) return;
                const txData = {
                    amount: parseFloat(amount),
                    note,
                    type,
                    category: type === 'expense' ? category : 'Sumber Pemasukan',
                    date: new Date(date).toISOString()
                };
                if (state.editingTransactionId) {
                    const idx = state.transactions.findIndex(t => t.id === state.editingTransactionId);
                    if (idx !== -1) state.transactions[idx] = { ...state.transactions[idx], ...txData };
                    state.editingTransactionId = null;
                } else {
                    state.transactions.unshift({ id: generateId(), ...txData });
                }
                saveData();
                resetTempTransaction();
                router.navigate('home');
            },
            deleteTransaction: (id) => {
                if(confirm('Yakin hapus transaksi ini?')) {
                    state.transactions = state.transactions.filter(t => t.id !== id);
                    state.editingTransactionId = null;
                    resetTempTransaction();
                    saveData();
                    router.navigate('home');
                }
            },
            setCalendarDate: (day) => {
                const newDate = new Date(state.calendarDate);
                newDate.setDate(day);
                state.calendarDate = newDate;
                renderContent();
            },
            changeMonth: (delta) => {
                state.calendarDate.setMonth(state.calendarDate.getMonth() + delta);
                renderContent();
            },
            toggleBudgetEditMode: () => {
                state.isBudgetEditMode = !state.isBudgetEditMode;
                renderContent();
            },
            toggleEditCategories: () => {
                state.isEditingCategories = !state.isEditingCategories;
                renderContent();
            },
            updateEstimatedIncome: (val) => {
                state.budgetSettings.estimatedIncome = parseInt(val) || 0;
            },
            addCategory: () => {
                const name = document.getElementById('new-cat-input').value;
                if (!name.trim()) return;
                const colors = getColors();
                const newAlloc = { id: generateId(), name: name, percentage: 0, color: colors[Math.floor(Math.random() * colors.length)] };
                state.budgetSettings.allocations.push(newAlloc);
                renderContent();
            },
            updateCategoryName: (id, val) => {
                const alloc = state.budgetSettings.allocations.find(a => a.id === id);
                if(alloc) alloc.name = val;
            },
            deleteCategory: (id) => {
                state.budgetSettings.allocations = state.budgetSettings.allocations.filter(a => a.id !== id);
                renderContent();
            },
            saveSettings: () => {
                saveData();
                state.isBudgetEditMode = false;
                router.navigate('analysis');
            },
            
            // BILL HANDLERS
            toggleAddBill: () => {
                state.isAddingBill = !state.isAddingBill;
                state.editingBillId = null;
                const defaultCat = state.budgetSettings.allocations.length > 0 ? state.budgetSettings.allocations[0].name : '';
                state.tempBill = { name: '', amount: '', date: '', type: 'monthly', category: defaultCat };
                renderContent();
            },
            setBillType: (type) => {
                state.tempBill.type = type;
                renderContent();
            },
            editBill: (id) => {
                const bill = state.bills.find(b => b.id === id);
                if (bill) {
                    state.editingBillId = id;
                    const defaultCat = state.budgetSettings.allocations.length > 0 ? state.budgetSettings.allocations[0].name : '';
                    state.tempBill = { 
                        name: bill.name, 
                        amount: bill.amount, 
                        date: bill.date,
                        type: bill.type || 'monthly',
                        category: bill.category || defaultCat
                    };
                    state.isAddingBill = true;
                    renderContent();
                }
            },
            handleBillAmount: (el) => {
                let rawValue = el.value.replace(/\D/g, '');
                state.tempBill.amount = rawValue ? parseFloat(rawValue) : '';
                el.value = rawValue ? formatRupiah(rawValue) : '';
            },
            submitBill: (e) => {
                e.preventDefault();
                const name = document.getElementById('bill-name').value;
                const date = document.getElementById('bill-date').value;
                const category = document.getElementById('bill-category').value;
                const amount = state.tempBill.amount;
                const type = state.tempBill.type;

                if(!name || !amount || !date) return;

                const billData = { name, date, amount, type, category };

                if (state.editingBillId) {
                    const idx = state.bills.findIndex(b => b.id === state.editingBillId);
                    if (idx !== -1) {
                        state.bills[idx] = { ...state.bills[idx], ...billData };
                    }
                    state.editingBillId = null;
                } else {
                    state.bills.push({ id: generateId(), ...billData });
                }

                saveData();
                state.isAddingBill = false;
                state.tempBill = { name: '', amount: '', date: '', type: 'monthly', category: '' };
                renderContent();
            },
            deleteBill: (id) => {
                state.bills = state.bills.filter(b => b.id !== id);
                saveData();
                renderContent();
            },
            markBillPaid: (id, periodKey) => {
                const bill = state.bills.find(b => b.id === id);
                if (bill) {
                    if (bill.type === 'onetime') {
                        bill.isPaid = true;
                    } else {
                        if (!bill.paidPeriods) bill.paidPeriods = [];
                        if (bill.paidPeriods.includes(periodKey)) return; 
                        bill.paidPeriods.push(periodKey);
                    }

                    // Auto add transaction (fixed: no confirm)
                    let categoryName = bill.category;
                    
                    if (!categoryName) {
                        categoryName = 'Tagihan & Utilitas';
                        const hasTagihanCat = state.budgetSettings.allocations.some(a => a.name === categoryName);
                        if (!hasTagihanCat && state.budgetSettings.allocations.length > 0) {
                            const match = state.budgetSettings.allocations.find(a => a.name.toLowerCase().includes('tagihan'));
                            categoryName = match ? match.name : state.budgetSettings.allocations[0].name;
                        }
                    }

                    state.transactions.unshift({
                        id: generateId(),
                        amount: parseFloat(bill.amount),
                        note: `Bayar Tagihan: ${bill.name}`,
                        type: 'expense',
                        category: categoryName,
                        date: new Date().toISOString()
                    });

                    saveData();
                    renderContent();
                }
            },
            togglePrintMode: () => {
                state.isPrintModalOpen = !state.isPrintModalOpen;
                renderContent();
            },
            setPrintDate: (type, value) => {
                if (type === 'start') state.printStartDate = value;
                if (type === 'end') state.printEndDate = value;
                renderContent(); 
            },
            printReport: () => {
                window.print();
            }
        };

        // --- ATTACH EVENTS ---
        const attachEventListeners = () => {
            // Nothing global needed for now, inline events used
        };

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            loadData();
            updateNavUI();
            renderContent();
        });

    </script>
</body>
</html>